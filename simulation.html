<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>리니지 클래식 캐릭터 시뮬레이터</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background-image: 
                radial-gradient(circle at 50% 0%, rgba(227, 192, 141, 0.05), transparent),
                url('https://www.transparenttextures.com/patterns/dark-leather.png');
        }

        .container-main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .header-title {
            text-align: center;
            color: var(--primary);
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 1rem;
            font-family: 'Cinzel', serif;
            letter-spacing: 2px;
            font-weight: 900;
        }

        /* Class Selector */
        .class-selector {
            display: flex;
            justify-content: space-around;
            margin-bottom: 1.5rem;
            gap: 1rem;
        }

        .class-card {
            cursor: pointer;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            transition: var(--transition);
            text-align: center;
            flex: 1;
            background: rgba(0,0,0,0.3);
            color: var(--text-dim);
        }

        .class-card:hover {
            border-color: var(--primary);
            background: rgba(227, 192, 141, 0.05);
        }

        .class-card.active {
            border-color: var(--primary);
            background: var(--gold-gradient);
            color: #111;
        }

        /* Portrait Container - Moved for Mobile */
        .portrait-container {
            background: rgba(0,0,0,0.5);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
            position: relative;
        }

        #class-portrait {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: opacity 0.3s ease-in-out;
        }

        /* Stat Rows */
        .stat-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.8rem;
            background: rgba(0,0,0,0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid transparent;
        }

        .stat-label {
            width: 50px;
            font-weight: 900;
            color: var(--primary);
            font-family: 'Cinzel', serif;
        }

        .stat-value {
            width: 30px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0 0.5rem;
            color: var(--text-main);
        }

        .stat-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.05);
            color: var(--primary);
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .stat-btn:hover:not(:disabled) {
            background: var(--primary);
            color: #111;
        }

        /* Status Panel */
        .status-panel {
            background: rgba(0,0,0,0.4);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            height: 100%;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.8rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.4rem;
        }

        .status-label { color: var(--text-dim); }
        .status-value { color: var(--text-main); font-weight: 700; }

        /* Equipment Grid */
        .equip-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 2rem;
        }

        .equip-slot {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.8rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .equip-label {
            font-size: 0.85rem;
            color: var(--primary);
            font-weight: 700;
            display: flex;
            justify-content: space-between;
        }

        .equip-select {
            background: var(--bg-deep);
            color: var(--text-main);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.4rem;
            font-size: 0.9rem;
            width: 100%;
        }

        .enchant-control {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .enchant-val {
            font-weight: 700;
            color: #ffcc00;
            width: 30px;
            text-align: center;
        }

        @media (max-width: 992px) {
            .equip-grid { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 768px) {
            .class-selector { display: grid; grid-template-columns: 1fr 1fr; }
            .container-main { padding: 1rem; margin: 0.5rem; }
            .portrait-container { height: 280px; margin-bottom: 1.5rem; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <header class="main-header">
        <a href="index.html" class="logo-link">
            <i data-lucide="shield-check" size="48" style="color: var(--primary);"></i>
            <div class="logo-text">
                <span class="line1">LINEAGE CLASSIC</span>
                <span class="line2">KNOWLEDGE BASE</span>
            </div>
        </a>
        <nav class="nav-menu">
            <a href="index.html" class="nav-item">
                <i data-lucide="book-open"></i>
                <span>사전</span>
            </a>
            <a href="quests.html" class="nav-item">
                <i data-lucide="scroll"></i>
                <span>퀘스트</span>
            </a>
            <a href="map.html" class="nav-item">
                <i data-lucide="map"></i>
                <span>지도</span>
            </a>
            <a href="simulation.html" class="nav-item active">
                <i data-lucide="flask-conical"></i>
                <span>모의실험</span>
            </a>
        </nav>
    </header>

    <div class="container-main">
        <h2 class="header-title">CHARACTER SIMULATOR</h2>

        <!-- Class Selection -->
        <div class="class-selector">
            <div class="class-card active" onclick="selectClass('monarch')">
                <div class="fs-5 fw-bold">군주</div>
                <div class="small">Monarch</div>
            </div>
            <div class="class-card" onclick="selectClass('knight')">
                <div class="fs-5 fw-bold">기사</div>
                <div class="small">Knight</div>
            </div>
            <div class="class-card" onclick="selectClass('elf')">
                <div class="fs-5 fw-bold">요정</div>
                <div class="small">Elf</div>
            </div>
            <div class="class-card" onclick="selectClass('wizard')">
                <div class="fs-5 fw-bold">마법사</div>
                <div class="small">Wizard</div>
            </div>
        </div>

        <!-- Portrait immediately after Class Selector (Optimized for Mobile) -->
        <div class="portrait-container">
            <img id="class-portrait" src="image/monarch.jpg" alt="Character Portrait">
        </div>

        <div class="row g-4">
            <!-- Left: Stats -->
            <div class="col-lg-6">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="m-0" style="color:var(--primary); font-weight:700;">BASE STATS</h5>
                    <span id="bonusPointsDisplay" class="badge bg-danger">8</span>
                </div>
                
                <div id="statControls">
                    <!-- Stats generated by JS -->
                </div>

                <div class="level-control mt-4 text-center p-3" style="background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid var(--border);">
                    <div class="mb-2 text-dim">CHARACTER LEVEL</div>
                    <div class="d-flex justify-content-center align-items-center gap-4">
                        <button class="stat-btn" style="width:40px; height:40px;" onclick="changeLevel(-1)">-</button>
                        <div class="fs-2 fw-bold text-warning" id="levelDisplay">Lv. 1</div>
                        <button class="stat-btn" style="width:40px; height:40px;" onclick="changeLevel(1)">+</button>
                    </div>
                </div>
            </div>

            <!-- Right: Status -->
            <div class="col-lg-6">
                <div class="status-panel">
                    <h5 class="mb-3 text-center" style="color:var(--primary); font-weight:700;">DETAILED STATS</h5>
                    <div class="status-item">
                        <span class="status-label">최대 HP</span>
                        <span class="status-value text-danger" id="display-hp">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">최대 MP</span>
                        <span class="status-value text-info" id="display-mp">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">방어력 (AC)</span>
                        <span class="status-value" id="display-ac">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">근거리 대미지</span>
                        <span class="status-value" id="display-melee-dmg">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">근거리 명중</span>
                        <span class="status-value" id="display-melee-hit">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">원거리 대미지</span>
                        <span class="status-value" id="display-ranged-dmg">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">원거리 명중</span>
                        <span class="status-value" id="display-ranged-hit">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">마법 방어 (MR)</span>
                        <span class="status-value" id="display-mr">0%</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">마법력 (SP)</span>
                        <span class="status-value" id="display-sp">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">스탯 보너스</span>
                        <span class="status-value small" id="display-bonus" style="font-weight:400; text-align:right;">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Equipment Section -->
        <div class="mt-5">
            <h5 style="color:var(--primary); font-weight:700; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                <i data-lucide="sword" style="vertical-align:text-bottom;"></i> EQUIPMENT
            </h5>
            <div class="equip-grid" id="equipGrid">
                <!-- Generated by JS -->
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { DATA } from './data.js';

    // -- Game Constants & Logic --
    const STAT_TYPES = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
    const STAT_LABELS = {str:'STR', dex:'DEX', con:'CON', int:'INT', wis:'WIS', cha:'CHA'};
    
    const CLASS_BASE = {
        monarch: { name:'군주', base:{str:13, dex:10, con:10, int:10, wis:11, cha:13}, bonus:8, hpBase:16, mpBase:2 },
        knight:  { name:'기사', base:{str:16, dex:12, con:14, int:8, wis:9, cha:12}, bonus:4, hpBase:20, mpBase:1 },
        elf:     { name:'요정', base:{str:11, dex:12, con:12, int:12, wis:12, cha:9}, bonus:7, hpBase:15, mpBase:4 },
        wizard:  { name:'마법사', base:{str:8, dex:7, con:12, int:12, wis:12, cha:8}, bonus:16, hpBase:12, mpBase:6 }
    };

    // Slots definition
    const SLOTS = [
        { id: 'weapon', label: '무기 (Weapon)', keywords: ['무기'] },
        { id: 'shield', label: '방패 (Shield)', keywords: ['방패', '마력서', '가더'] },
        { id: 'helm',   label: '투구 (Helm)',   keywords: ['투구', '모자', '두건', '면갑'] },
        { id: 'armor',  label: '갑옷 (Armor)',  keywords: ['갑옷', '로브', '재킷', '조끼', '판금', '껍질'] },
        { id: 'shirt',  label: '티셔츠 (Shirt)', keywords: ['티셔츠'] },
        { id: 'cloak',  label: '망토 (Cloak)',  keywords: ['망토', '위엄'] },
        { id: 'gloves', label: '장갑 (Gloves)', keywords: ['장갑', '글로브', '골무'] },
        { id: 'boots',  label: '신발 (Boots)',  keywords: ['부츠', '장화', '샌달'] },
        { id: 'neck',   label: '목걸이 (Neck)', keywords: ['목걸이'] },
        { id: 'belt',   label: '벨트 (Belt)',   keywords: ['벨트'] },
        { id: 'ring1',  label: '반지 1 (Ring)', keywords: ['반지'] },
        { id: 'ring2',  label: '반지 2 (Ring)', keywords: ['반지'] },
    ];

    // -- State --
    let state = {
        class: 'monarch',
        level: 1,
        stats: { ...CLASS_BASE.monarch.base },
        bonusRemaining: 8,
        equipment: {} // { slotId: { itemId, enchant } }
    };

    // Initialize Equipment State
    SLOTS.forEach(s => state.equipment[s.id] = { itemId: '', enchant: 0 });

    // -- DOM Elements --
    const statControls = document.getElementById('statControls');
    const equipGrid = document.getElementById('equipGrid');

    // -- Initialization --
    function init() {
        renderStatControls();
        renderEquipSlots();
        updateDisplay();
        window.lucide.createIcons();
    }

    // -- Renderers --
    function renderStatControls() {
        statControls.innerHTML = STAT_TYPES.map(stat => `
            <div class="stat-row">
                <div class="stat-label">${STAT_LABELS[stat]}</div>
                <div class="d-flex align-items-center">
                    <button class="stat-btn" onclick="window.changeStat('${stat}', -1)">-</button>
                    <div class="stat-value" id="val-${stat}">${state.stats[stat]}</div>
                    <button class="stat-btn" onclick="window.changeStat('${stat}', 1)">+</button>
                </div>
                <div class="ms-auto small text-dim" id="desc-${stat}" style="font-size:0.75rem"></div>
            </div>
        `).join('');
    }

    function renderEquipSlots() {
        // Collect ALL items from DATA
        const allItems = [
            ...(DATA.items || []), 
            ...(DATA.spells || []), // Spells are not items, ignore
            ...(DATA.crafting || []) // Crafting might have item names
        ].filter(i => i.stats); // Ensure stats exist

        // Clean duplicates by name preference (DATA.items usually has stats)
        const uniqueItems = [];
        const seen = new Set();
        // Priority: items > crafting.
        [...(DATA.items || [])].forEach(i => {
            if(!seen.has(i.name)) { uniqueItems.push(i); seen.add(i.name); }
        });

        equipGrid.innerHTML = SLOTS.map(slot => {
            // Filter items for this slot
            const validItems = uniqueItems.filter(item => {
                // Special handling for Accessories overlap or specific exclusions could go here
                // For Ring, check '반지', exclude '변신 조종' if needed? No, include all rings.
                return slot.keywords.some(kw => item.name.includes(kw) || (item.category && item.category.includes(kw)));
            }).sort((a,b) => a.name.localeCompare(b.name));

            return `
                <div class="equip-slot" id="slot-${slot.id}">
                    <div class="equip-label">
                        <span>${slot.label}</span>
                        <span class="enchant-control">
                            <button class="stat-btn" style="width:20px;height:20px;font-size:0.8rem" onclick="window.changeEnchant('${slot.id}', -1)">-</button>
                            <span class="enchant-val" id="enchant-${slot.id}">+0</span>
                            <button class="stat-btn" style="width:20px;height:20px;font-size:0.8rem" onclick="window.changeEnchant('${slot.id}', 1)">+</button>
                        </span>
                    </div>
                    <select class="equip-select" onchange="window.equipItem('${slot.id}', this.value)">
                        <option value="">(장착 해제)</option>
                        ${validItems.map(i => `<option value="${i.name}">${i.name}</option>`).join('')}
                    </select>
                    <div class="small text-dim mt-1" id="desc-${slot.id}" style="font-size:0.75rem; min-height:1.2em;"></div>
                </div>
            `;
        }).join('');
    }

    // -- Actions --
    window.selectClass = (cls) => {
        state.class = cls;
        state.stats = { ...CLASS_BASE[cls].base };
        state.bonusRemaining = CLASS_BASE[cls].bonus;
        state.level = 1;
        
        // Update Portrait Image
        const portrait = document.getElementById('class-portrait');
        if (portrait) {
            portrait.style.opacity = '0';
            setTimeout(() => {
                portrait.src = `image/${cls}.jpg`;
                portrait.style.opacity = '1';
            }, 150);
        }

        // Reset Equipment? No, keep it but maybe warn if restricted.
        // Re-render class cards
        document.querySelectorAll('.class-card').forEach(c => c.classList.remove('active'));
        // Find card by text content match
        const cards = Array.from(document.querySelectorAll('.class-card'));
        const target = cards.find(c => c.innerText.includes(CLASS_BASE[cls].name));
        if(target) target.classList.add('active');

        // Update UI stats
        STAT_TYPES.forEach(s => document.getElementById(`val-${s}`).innerText = state.stats[s]);
        document.getElementById('bonusPointsDisplay').innerText = state.bonusRemaining;
        
        updateDisplay();
    };

    window.changeStat = (stat, delta) => {
        const currentVal = state.stats[stat];
        const baseVal = CLASS_BASE[state.class].base[stat];
        const maxVal = stat === 'str' ? 20 : 18;

        if (delta > 0 && state.bonusRemaining > 0 && currentVal < maxVal) {
            state.stats[stat]++;
            state.bonusRemaining--;
        } else if (delta < 0 && currentVal > baseVal) {
            state.stats[stat]--;
            state.bonusRemaining++;
        }
        document.getElementById(`val-${stat}`).innerText = state.stats[stat];
        document.getElementById('bonusPointsDisplay').innerText = state.bonusRemaining;
        updateDisplay();
    };

    window.changeLevel = (delta) => {
        const next = state.level + delta;
        if (next >= 1 && next <= 99) {
            state.level = next;
            document.getElementById('levelDisplay').innerText = `Lv. ${state.level}`;
            updateDisplay();
        }
    };

    window.equipItem = (slotId, itemName) => {
        state.equipment[slotId].itemId = itemName;
        
        // Logic: 2-Handed Weapon
        if (slotId === 'weapon') {
            const item = getItem(itemName);
            if (item && item.stats && item.stats.includes('양손')) {
                // Unequip shield
                state.equipment['shield'].itemId = '';
                const shieldSelect = document.querySelector('#slot-shield select');
                if(shieldSelect) shieldSelect.value = '';
            }
        }
        updateDisplay();
    };

    window.changeEnchant = (slotId, delta) => {
        const current = state.equipment[slotId].enchant;
        const next = current + delta;
        if (next >= 0 && next <= 11) {
            state.equipment[slotId].enchant = next;
            document.getElementById(`enchant-${slotId}`).innerText = `+${next}`;
            updateDisplay();
        }
    };

    // -- Calculations --
    function getItem(name) {
        if(!name) return null;
        return DATA.items.find(i => i.name === name) || DATA.crafting.find(i => i.name === name);
    }

    function parseStats(statsStr) {
        if(!statsStr) return {};
        const parts = statsStr.split('|').map(s => s.trim());
        
        let dmgSmall = 0, dmgLarge = 0;
        if (parts[0].includes('/')) {
            const d = parts[0].split('/');
            dmgSmall = parseInt(d[0]) || 0;
            dmgLarge = parseInt(d[1]) || 0;
        }

        let ac = 0;
        const isWeapon = parts[0].includes('/');
        if (!isWeapon) {
            ac = parseInt(parts[0]) || 0; 
        }

        const rawText = statsStr;
        const isTwoHanded = rawText.includes('양손');
        
        let bonuses = { str:0, dex:0, con:0, int:0, wis:0, cha:0, hp:0, mp:0, mr:0, sp:0 };
        
        const regexes = [
            { key: 'str', re: /STR\s*([+-]?\d+)/i },
            { key: 'dex', re: /DEX\s*([+-]?\d+)/i },
            { key: 'con', re: /CON\s*([+-]?\d+)/i },
            { key: 'int', re: /INT\s*([+-]?\d+)/i },
            { key: 'wis', re: /WIS\s*([+-]?\d+)/i },
            { key: 'cha', re: /CHA\s*([+-]?\d+)/i },
            { key: 'hp', re: /최대\s*HP\s*([+-]?\d+)/i },
            { key: 'mp', re: /최대\s*MP\s*([+-]?\d+)/i },
            { key: 'mr', re: /MR\s*([+-]?\d+)/i },
            { key: 'sp', re: /SP\s*([+-]?\d+)/i }
        ];

        regexes.forEach(r => {
            const m = rawText.match(r.re);
            if(m) bonuses[r.key] += parseInt(m[1]);
        });

        return { isWeapon, dmgSmall, dmgLarge, ac, isTwoHanded, bonuses, rawText };
    }

    function updateDisplay() {
        const { stats, level, class: clsName, equipment } = state;
        const clsData = CLASS_BASE[clsName];

        let hpGrowth = 0;
        let mpGrowth = 0;
        
        if (stats.con >= 18) hpGrowth = clsData.hpBase + 6; 
        else if (stats.con >= 16) hpGrowth = clsData.hpBase + 4;
        else hpGrowth = clsData.hpBase + 2;

        if (stats.wis >= 18) mpGrowth = clsData.mpBase + 4;
        else if (stats.wis >= 15) mpGrowth = clsData.mpBase + 2;
        else mpGrowth = clsData.mpBase + 1;

        let maxHP = Math.floor(clsData.hpBase + (hpGrowth * (level - 1)));
        let maxMP = Math.floor(clsData.mpBase + (mpGrowth * (level - 1)));

        let baseAC = 10;
        let dexACBonus = 0;
        if (stats.dex >= 18) dexACBonus = 8;
        else if (stats.dex >= 16) dexACBonus = 6;
        else if (stats.dex >= 13) dexACBonus = 4;
        else if (stats.dex >= 10) dexACBonus = 2;
        
        baseAC -= dexACBonus;
        if (clsName === 'knight') baseAC -= Math.floor(level / 3); 

        let equipAC = 0;
        let equipDmg = 0;
        let equipHit = 0;
        let equipRangedDmg = 0;
        let equipRangedHit = 0;
        let equipMR = 0;
        let equipSP = 0;
        let addedStats = { str:0, dex:0, con:0, int:0, wis:0, cha:0 };

        for (const [slot, data] of Object.entries(equipment)) {
            if (!data.itemId) continue;
            const item = getItem(data.itemId);
            if (!item) continue;

            const parsed = parseStats(item.stats);
            const enchant = data.enchant;

            maxHP += parsed.bonuses.hp;
            maxMP += parsed.bonuses.mp;
            equipMR += parsed.bonuses.mr;
            equipSP += parsed.bonuses.sp;
            
            for(let k in parsed.bonuses) {
                if(STAT_TYPES.includes(k)) addedStats[k] += parsed.bonuses[k];
            }

            if (!parsed.isWeapon) {
                equipAC += (parsed.ac - enchant);
            }

            if (parsed.isWeapon) {
                const isBow = item.name.includes('활') || item.name.includes('크로스') || item.name.includes('장궁');
                const isStaff = item.name.includes('지팡이');
                const baseDmgAvg = (parsed.dmgSmall + parsed.dmgLarge) / 2;
                
                if (isBow) {
                    equipRangedDmg += baseDmgAvg + enchant;
                    equipRangedHit += enchant;
                    const mDmg = parsed.rawText.match(/원거리\s*대미지\s*([+-]?\d+)/);
                    if(mDmg) equipRangedDmg += parseInt(mDmg[1]);
                    const mHit = parsed.rawText.match(/원거리\s*명중\s*([+-]?\d+)/);
                    if(mHit) equipRangedHit += parseInt(mHit[1]);
                } else {
                    equipDmg += baseDmgAvg + enchant;
                    equipHit += enchant;
                    if (isStaff && enchant >= 6) {
                        equipSP += 1;
                        if (enchant >= 9) equipSP += 1;
                    }
                }
            } else {
                if (['ring1', 'ring2', 'neck', 'belt'].includes(slot)) {
                    equipAC += -(Math.floor(enchant / 2)); 
                }
            }
        }

        const finalStats = {};
        STAT_TYPES.forEach(s => finalStats[s] = stats[s] + addedStats[s]);

        const strBonus = Math.floor((finalStats.str - 10) / 2);
        const dexHitBonus = Math.floor((finalStats.dex - 10) / 3);
        const dexDmgBonus = Math.floor((finalStats.dex - 10) / 3); 
        const intSPBonus = Math.floor((finalStats.int - 10) / 3); 

        const totalAC = baseAC + equipAC;
        const totalMeleeDmg = strBonus + equipDmg + Math.floor(level/10);
        const totalMeleeHit = strBonus + dexHitBonus + equipHit + level;
        const totalRangedDmg = dexDmgBonus + equipRangedDmg + Math.floor(level/10);
        const totalRangedHit = dexHitBonus + equipRangedHit + level + 2; 
        const totalMR = Math.floor(finalStats.wis * 2) + Math.floor(level/2) + equipMR;
        const totalSP = intSPBonus + equipSP + (clsName === 'wizard' ? 4 : 0); 

        document.getElementById('display-hp').innerText = maxHP;
        document.getElementById('display-mp').innerText = maxMP;
        document.getElementById('display-ac').innerText = totalAC;
        document.getElementById('display-ac').style.color = totalAC < 0 ? '#4da6ff' : '#fff';
        
        document.getElementById('display-melee-dmg').innerText = totalMeleeDmg;
        document.getElementById('display-melee-hit').innerText = totalMeleeHit;
        document.getElementById('display-ranged-dmg').innerText = totalRangedDmg;
        document.getElementById('display-ranged-hit').innerText = totalRangedHit;
        
        document.getElementById('display-mr').innerText = `${totalMR}%`;
        document.getElementById('display-sp').innerText = totalSP;

        const bonusText = Object.entries(addedStats)
            .filter(([_,v]) => v !== 0)
            .map(([k,v]) => `${k.toUpperCase()} ${v>0?'+':''}${v}`)
            .join(', ');
        document.getElementById('display-bonus').innerText = bonusText || 'None';
    }

    window.onload = init;
</script>

</body>
</html>
